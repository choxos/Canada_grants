{% extends 'base.html' %}
{% load humanize %}

{% block title %}Global Affairs Canada - Statistics{% endblock %}

{% block extra_head %}
<style>
    .plotly-graph-div {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-chart-bar"></i> Global Affairs Canada - Grant Statistics</h1>
        <p class="lead text-muted">Comprehensive analysis of Canada's international development assistance</p>
    </div>
</div>

<!-- Basic Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-globe-americas"></i></h3>
            <h2>{{ total_grants|intcomma }}</h2>
            <p>Total International Grants</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-dollar-sign"></i></h3>
            <h2>${{ total_value|floatformat:0|intcomma }}</h2>
            <p>Total Committed Value</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-chart-line"></i></h3>
            <h2>${{ avg_value|floatformat:0|intcomma }}</h2>
            <p>Average Grant Value</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-star"></i></h3>
            <h2>{{ major_count|intcomma }}</h2>
            <p>Major Funding (>$1M)</p>
            <small class="text-light">${{ major_value|floatformat:0|intcomma }}</small>
        </div>
    </div>
</div>

<!-- Policy Markers Overview -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ gender_grants|intcomma }}</h3>
                <p><i class="fas fa-equals"></i> Gender Equality Focus</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-success">{{ env_grants|intcomma }}</h3>
                <p><i class="fas fa-leaf"></i> Environmental Sustainability</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ governance_grants|intcomma }}</h3>
                <p><i class="fas fa-balance-scale"></i> Good Governance</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <!-- Grant Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Grant Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Countries by Funding -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-globe"></i> Top Countries by Funding</h5>
            </div>
            <div class="card-body">
                <canvas id="countryChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top Regions -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map"></i> Regional Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="regionChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- World Choropleth Map -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-globe-americas"></i> World Funding Distribution</h5>
                <small class="text-muted">Choropleth map showing Canadian funding by country</small>
            </div>
            <div class="card-body">
                <div id="worldMap" style="height: 600px; width: 100%;"></div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Interactive choropleth map showing Canadian funding by country. Hover over countries for details.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="row">
    <!-- Top Countries Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-flag"></i> Top 15 Countries by Investment</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Grants</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="countriesTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Regions Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-map-marked-alt"></i> Top 10 Regions by Investment</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Grants</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="regionsTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from Django template
    const statusData = {{ status_data|safe }};
    const countryData = {{ country_data|safe }};
    const regionData = {{ region_data|safe }};
    
    // Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1)),
            datasets: [{
                data: statusData.map(d => d.total_value),
                backgroundColor: ['#28a745', '#6c757d', '#ffc107'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const status = statusData[context.dataIndex];
                            return `${context.label}: ${status.count.toLocaleString()} grants ($${(status.total_value/1000000).toFixed(0)}M)`;
                        }
                    }
                }
            }
        }
    });
    
    // Top Countries Chart
    const countryCtx = document.getElementById('countryChart').getContext('2d');
    const topCountries = countryData.slice(0, 10);
    new Chart(countryCtx, {
        type: 'bar',
        data: {
            labels: topCountries.map(d => d.country),
            datasets: [{
                label: 'Total Value (Millions CAD)',
                data: topCountries.map(d => d.total_value / 1000000),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const country = topCountries[context.dataIndex];
                            return `${context.dataset.label}: $${context.parsed.x.toFixed(0)}M (${country.count} grants)`;
                        }
                    }
                }
            },
            scales: {
                x: { 
                    title: { display: true, text: 'Value (Millions CAD)' },
                    beginAtZero: true
                },
                y: { title: { display: true, text: 'Country' } }
            }
        }
    });
    
    // Regional Chart
    const regionCtx = document.getElementById('regionChart').getContext('2d');
    const topRegions = regionData.slice(0, 12);
    new Chart(regionCtx, {
        type: 'bar',
        data: {
            labels: topRegions.map(d => d.region.length > 25 ? d.region.substring(0, 25) + '...' : d.region),
            datasets: [{
                label: 'Total Value (Millions CAD)',
                data: topRegions.map(d => d.total_value / 1000000),
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const region = topRegions[context.dataIndex];
                            return `${context.dataset.label}: $${context.parsed.y.toFixed(0)}M (${region.count} grants)`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    title: { display: true, text: 'Value (Millions CAD)' },
                    beginAtZero: true
                },
                x: { 
                    title: { display: true, text: 'Region' },
                    ticks: { maxRotation: 45 }
                }
            }
        }
    });
    
    // Populate Countries Table
    const countriesTableBody = document.getElementById('countriesTable');
    countryData.slice(0, 15).forEach(country => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${country.country}</strong></td>
            <td>${country.count.toLocaleString()}</td>
            <td class="text-success">$${(country.total_value/1000000).toFixed(0)}M</td>
        `;
        countriesTableBody.appendChild(row);
    });
    
    // Populate Regions Table
    const regionsTableBody = document.getElementById('regionsTable');
    regionData.slice(0, 10).forEach(region => {
        const row = document.createElement('tr');
        const regionName = region.region.length > 30 ? region.region.substring(0, 30) + '...' : region.region;
        row.innerHTML = `
            <td><strong>${regionName}</strong></td>
            <td>${region.count.toLocaleString()}</td>
            <td class="text-success">$${(region.total_value/1000000).toFixed(0)}M</td>
        `;
        regionsTableBody.appendChild(row);
    });
    
    console.log('GAC Statistics charts initialized successfully!');
    
    // Initialize World Choropleth Map with Plotly (loaded via extra_js block like democracy-analysis)
    setTimeout(initPlotlyWorldMap, 100);
    
    // Plotly World Choropleth Map
    function initPlotlyWorldMap() {
        console.log('🗺️ Initializing Plotly world map...');
        console.log('🔍 Checking Plotly availability:', typeof Plotly);
        
        // Check if Plotly is available
        if (typeof Plotly === 'undefined') {
            console.error('❌ Plotly library not loaded from CDN');
            console.log('💡 Trying to wait a bit more and retry...');
            
            // Try waiting a bit more for slow connections
            setTimeout(function() {
                console.log('🔍 Retrying Plotly check:', typeof Plotly);
                if (typeof Plotly !== 'undefined') {
                    console.log('✅ Plotly loaded on retry - initializing map');
                    createPlotlyMap();
                } else {
                    console.error('❌ Plotly still not available after retry');
                    showMapError();
                }
            }, 1000);
            return;
        }
        
        console.log('✅ Plotly library ready - creating map');
        createPlotlyMap();
    }
    
    // Show map error message
    function showMapError() {
        document.getElementById('worldMap').innerHTML = 
            '<div class="alert alert-warning text-center m-4">' +
            '<i class="fas fa-exclamation-triangle"></i> ' +
            '<strong>Map Library Loading Issue</strong><br>' +
            'Unable to load Plotly.js from CDN. This may be due to network restrictions.' +
            '<br><small class="text-muted">CDN: cdn.jsdelivr.net (Plotly v2.24.1) - same as democracy-analysis</small>' +
            '<br><br><button class="btn btn-primary btn-sm" onclick="location.reload()">Try Again</button>' +
            '</div>';
    }
    
    // Create the actual Plotly map
    function createPlotlyMap() {
        
        // Safety check for data (like democracy-analysis does)
        if (!countryData || !Array.isArray(countryData) || countryData.length === 0) {
            console.error('Invalid world map data structure:', countryData);
            document.getElementById('worldMap').innerHTML = 
                '<div class="alert alert-warning">No data available for world map</div>';
            return;
        }
        
        console.log('📊 Creating world map with', countryData.length, 'countries');
        console.log('🔍 Sample country data:', countryData.slice(0, 3));
        
        // Map country names to what Plotly expects
        function mapCountryName(countryName) {
            const mapping = {
                'United States': 'United States of America',
                'USA': 'United States of America',
                'UK': 'United Kingdom',
                'Russia': 'Russian Federation',
                'South Korea': 'Korea, Republic of',
                'North Korea': 'Korea, Democratic People\'s Republic of',
                'Iran': 'Iran, Islamic Republic of',
                'Syria': 'Syrian Arab Republic',
                'Venezuela': 'Venezuela, Bolivarian Republic of',
                'Bolivia': 'Bolivia, Plurinational State of',
                'Tanzania': 'Tanzania, United Republic of',
                'Congo': 'Congo, Republic of the',
                'DR Congo': 'Congo, Democratic Republic of the',
                'Democratic Republic of the Congo': 'Congo, Democratic Republic of the',
                'Czech Republic': 'Czechia',
                'Macedonia': 'North Macedonia',
                'Myanmar': 'Burma',
                'Ivory Coast': 'Cote d\'Ivoire',
                'Swaziland': 'Eswatini'
            };
            
            return mapping[countryName] || countryName;
        }
        
        // Create plot data with improved country name mapping
        const plotData = [{
            type: 'choropleth',
            locationmode: 'country names',
            locations: countryData.map(c => mapCountryName(c.country)),
            z: countryData.map(c => c.total_value / 1000000), // Convert to millions
            text: countryData.map(c => 
                `Country: ${c.country}<br>Funding: $${(c.total_value/1000000).toFixed(1)}M CAD<br>Grants: ${c.count}`
            ),
            hovertemplate: '%{text}<extra></extra>',
            colorscale: [
                [0, 'rgb(220, 38, 38)'],   // Red for low funding
                [0.5, 'rgb(251, 191, 36)'], // Yellow for medium funding
                [1, 'rgb(34, 197, 94)']     // Green for high funding
            ],
            colorbar: {
                title: 'Funding (Millions CAD)',
                titlefont: { size: 14 }
            }
        }];
        
        console.log('🗺️ Mapped locations:', plotData[0].locations.slice(0, 5));
        
        const layout = {
            title: {
                text: 'Global Affairs Canada Funding by Country',
                font: { size: 18, weight: 'bold' }
            },
            geo: {
                showframe: false,
                showcoastlines: true,
                projection: { type: 'natural earth' }
            },
            margin: { t: 50, b: 0, l: 0, r: 0 }
        };
        
        // Use the same simple call as democracy-analysis
        Plotly.newPlot('worldMap', plotData, layout, {responsive: true});
        console.log('✅ Plotly world map created successfully!');
    }
});
</script>
{% endblock %}

{% block extra_js %}
<!-- Plotly.js for world map (loaded at end like democracy-analysis) -->
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.1/plotly.min.js"></script>
{% endblock %}
