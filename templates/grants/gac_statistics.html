{% extends 'base.html' %}
{% load humanize %}

{% block title %}Global Affairs Canada - Statistics{% endblock %}

{% block extra_head %}
<script>
// Multiple CDN fallback system with detailed diagnostics
window.plotlyLoadingAttempts = [];
window.plotlyLoadingStatus = 'starting';

function loadPlotlyWithFallback() {
    const cdnSources = [
        'https://cdn.plot.ly/plotly-latest.min.js',
        'https://cdn.jsdelivr.net/npm/plotly.js-dist@latest/plotly.min.js',
        'https://unpkg.com/plotly.js-dist@latest/plotly.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js'
    ];
    
    let currentCdnIndex = 0;
    
    function tryNextCdn() {
        if (currentCdnIndex >= cdnSources.length) {
            console.error('‚ùå All Plotly CDNs failed to load');
            window.plotlyLoadingStatus = 'all_failed';
            return;
        }
        
        const cdnUrl = cdnSources[currentCdnIndex];
        const attemptInfo = {
            index: currentCdnIndex + 1,
            url: cdnUrl,
            timestamp: Date.now()
        };
        
        console.log(`üîÑ Trying Plotly CDN ${attemptInfo.index}/4: ${cdnUrl}`);
        window.plotlyLoadingAttempts.push(attemptInfo);
        
        const script = document.createElement('script');
        script.src = cdnUrl;
        
        script.onload = function() {
            attemptInfo.status = 'loaded';
            attemptInfo.loadTime = Date.now() - attemptInfo.timestamp;
            console.log(`‚úÖ Plotly CDN ${attemptInfo.index} loaded successfully in ${attemptInfo.loadTime}ms`);
            window.plotlyLoadingStatus = 'loaded';
        };
        
        script.onerror = function() {
            attemptInfo.status = 'failed';
            attemptInfo.loadTime = Date.now() - attemptInfo.timestamp;
            console.warn(`‚ùå Plotly CDN ${attemptInfo.index} failed after ${attemptInfo.loadTime}ms`);
            currentCdnIndex++;
            tryNextCdn();
        };
        
        document.head.appendChild(script);
    }
    
    tryNextCdn();
}

// Start loading immediately
loadPlotlyWithFallback();
</script>
<style>
    .plotly-graph-div {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-chart-bar"></i> Global Affairs Canada - Grant Statistics</h1>
        <p class="lead text-muted">Comprehensive analysis of Canada's international development assistance</p>
    </div>
</div>

<!-- Basic Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-globe-americas"></i></h3>
            <h2>{{ total_grants|intcomma }}</h2>
            <p>Total International Grants</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-dollar-sign"></i></h3>
            <h2>${{ total_value|floatformat:0|intcomma }}</h2>
            <p>Total Committed Value</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-chart-line"></i></h3>
            <h2>${{ avg_value|floatformat:0|intcomma }}</h2>
            <p>Average Grant Value</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card text-center p-3">
            <h3><i class="fas fa-star"></i></h3>
            <h2>{{ major_count|intcomma }}</h2>
            <p>Major Funding (>$1M)</p>
            <small class="text-light">${{ major_value|floatformat:0|intcomma }}</small>
        </div>
    </div>
</div>

<!-- Policy Markers Overview -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ gender_grants|intcomma }}</h3>
                <p><i class="fas fa-equals"></i> Gender Equality Focus</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-success">{{ env_grants|intcomma }}</h3>
                <p><i class="fas fa-leaf"></i> Environmental Sustainability</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ governance_grants|intcomma }}</h3>
                <p><i class="fas fa-balance-scale"></i> Good Governance</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <!-- Grant Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Grant Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Countries by Funding -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-globe"></i> Top Countries by Funding</h5>
            </div>
            <div class="card-body">
                <canvas id="countryChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top Regions -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map"></i> Regional Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="regionChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- World Choropleth Map -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-globe-americas"></i> World Funding Distribution</h5>
                <small class="text-muted">Choropleth map showing Canadian funding by country</small>
            </div>
            <div class="card-body">
                <div id="worldMap" style="height: 600px; width: 100%;"></div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Interactive choropleth map showing Canadian funding by country. Hover over countries for details.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="row">
    <!-- Top Countries Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-flag"></i> Top 15 Countries by Investment</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Grants</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="countriesTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Regions Table -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-map-marked-alt"></i> Top 10 Regions by Investment</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Grants</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="regionsTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Data from Django template
    const statusData = {{ status_data|safe }};
    const countryData = {{ country_data|safe }};
    const regionData = {{ region_data|safe }};
    
    // Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: statusData.map(d => d.status.charAt(0).toUpperCase() + d.status.slice(1)),
            datasets: [{
                data: statusData.map(d => d.total_value),
                backgroundColor: ['#28a745', '#6c757d', '#ffc107'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const status = statusData[context.dataIndex];
                            return `${context.label}: ${status.count.toLocaleString()} grants ($${(status.total_value/1000000).toFixed(0)}M)`;
                        }
                    }
                }
            }
        }
    });
    
    // Top Countries Chart
    const countryCtx = document.getElementById('countryChart').getContext('2d');
    const topCountries = countryData.slice(0, 10);
    new Chart(countryCtx, {
        type: 'bar',
        data: {
            labels: topCountries.map(d => d.country),
            datasets: [{
                label: 'Total Value (Millions CAD)',
                data: topCountries.map(d => d.total_value / 1000000),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const country = topCountries[context.dataIndex];
                            return `${context.dataset.label}: $${context.parsed.x.toFixed(0)}M (${country.count} grants)`;
                        }
                    }
                }
            },
            scales: {
                x: { 
                    title: { display: true, text: 'Value (Millions CAD)' },
                    beginAtZero: true
                },
                y: { title: { display: true, text: 'Country' } }
            }
        }
    });
    
    // Regional Chart
    const regionCtx = document.getElementById('regionChart').getContext('2d');
    const topRegions = regionData.slice(0, 12);
    new Chart(regionCtx, {
        type: 'bar',
        data: {
            labels: topRegions.map(d => d.region.length > 25 ? d.region.substring(0, 25) + '...' : d.region),
            datasets: [{
                label: 'Total Value (Millions CAD)',
                data: topRegions.map(d => d.total_value / 1000000),
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const region = topRegions[context.dataIndex];
                            return `${context.dataset.label}: $${context.parsed.y.toFixed(0)}M (${region.count} grants)`;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    title: { display: true, text: 'Value (Millions CAD)' },
                    beginAtZero: true
                },
                x: { 
                    title: { display: true, text: 'Region' },
                    ticks: { maxRotation: 45 }
                }
            }
        }
    });
    
    // Populate Countries Table
    const countriesTableBody = document.getElementById('countriesTable');
    countryData.slice(0, 15).forEach(country => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${country.country}</strong></td>
            <td>${country.count.toLocaleString()}</td>
            <td class="text-success">$${(country.total_value/1000000).toFixed(0)}M</td>
        `;
        countriesTableBody.appendChild(row);
    });
    
    // Populate Regions Table
    const regionsTableBody = document.getElementById('regionsTable');
    regionData.slice(0, 10).forEach(region => {
        const row = document.createElement('tr');
        const regionName = region.region.length > 30 ? region.region.substring(0, 30) + '...' : region.region;
        row.innerHTML = `
            <td><strong>${regionName}</strong></td>
            <td>${region.count.toLocaleString()}</td>
            <td class="text-success">$${(region.total_value/1000000).toFixed(0)}M</td>
        `;
        regionsTableBody.appendChild(row);
    });
    
    console.log('GAC Statistics charts initialized successfully!');
    
    // Initialize World Choropleth Map with Plotly (wait for library to load)
    waitForPlotlyAndInit();
    
    // Wait for Plotly library to load before initializing map
    function waitForPlotlyAndInit() {
        let attempts = 0;
        const maxAttempts = 100; // 10 seconds max wait (longer for multiple CDN attempts)
        
        function checkPlotly() {
            if (typeof Plotly !== 'undefined') {
                console.log('‚úÖ Plotly library is ready - initializing map');
                initPlotlyWorldMap();
                return;
            }
            
            // Check if all CDNs have been tried and failed
            if (window.plotlyLoadingStatus === 'all_failed') {
                console.error('‚ùå All Plotly CDNs failed to load');
                showPlotlyError();
                return;
            }
            
            // Continue waiting if CDNs are still being tried or loaded
            if (attempts < maxAttempts) {
                attempts++;
                setTimeout(checkPlotly, 100);
            } else {
                console.error('‚ùå Plotly loading timed out after 10 seconds');
                console.log('üîç Loading attempts:', window.plotlyLoadingAttempts);
                console.log('üìä Final loading status:', window.plotlyLoadingStatus);
                showPlotlyError();
            }
        }
        
        checkPlotly();
    }
    
    // Show error message if Plotly fails to load
    function showPlotlyError() {
        const attemptCount = window.plotlyLoadingAttempts.length;
        const failedCdns = window.plotlyLoadingAttempts
            .filter(attempt => attempt.status === 'failed')
            .map(attempt => attempt.url.split('/')[2]) // Extract domain
            .join(', ');
        
        document.getElementById('worldMap').innerHTML = 
            '<div class="alert alert-warning text-center m-4">' +
            '<i class="fas fa-exclamation-triangle"></i> ' +
            '<strong>Map Visualization Unavailable</strong><br>' +
            `Unable to load interactive map after trying ${attemptCount} CDN(s).` +
            '<br><small class="text-muted">This may be due to network restrictions, ad blockers, or firewall settings.</small>' +
            '<br><br><button class="btn btn-primary btn-sm me-2" onclick="location.reload()">Try Again</button>' +
            '<button class="btn btn-secondary btn-sm" onclick="showDiagnostics()">Show Diagnostics</button>' +
            '<div id="diagnostics" class="mt-3" style="display:none;">' +
            '<small class="text-muted">' +
            '<strong>Attempted CDNs:</strong><br>' +
            window.plotlyLoadingAttempts.map(attempt => 
                `‚Ä¢ ${attempt.url.split('/')[2]}: ${attempt.status || 'trying'} (${attempt.loadTime || '?'}ms)`
            ).join('<br>') +
            '</small></div>' +
            '</div>';
    }
    
    // Make showDiagnostics globally available for onclick
    window.showDiagnostics = function() {
        const diagnostics = document.getElementById('diagnostics');
        if (diagnostics) {
            diagnostics.style.display = diagnostics.style.display === 'none' ? 'block' : 'none';
        }
    };
    
    // Plotly World Choropleth Map (moved inside DOMContentLoaded to access data)
    function initPlotlyWorldMap() {
        console.log('üó∫Ô∏è Initializing Plotly world map...');
        
        // Prepare data for Plotly
        const countries = [];
        const values = [];
        const hoverText = [];
        const countCounts = [];
    
    countryData.forEach(item => {
        let countryName = item.country.trim();
        
        // Handle common country name variations for Plotly
        if (countryName === 'Democratic Republic of the Congo') countryName = 'Congo, Democratic Republic of the';
        if (countryName === 'Republic of the Congo') countryName = 'Congo, Republic of the';
        if (countryName === 'United States of America') countryName = 'United States';
        if (countryName === 'Russian Federation') countryName = 'Russia';
        if (countryName === 'United Kingdom') countryName = 'United Kingdom';
        if (countryName === 'South Korea') countryName = 'Korea, South';
        if (countryName === 'North Korea') countryName = 'Korea, North';
        if (countryName === 'Czech Republic') countryName = 'Czechia';
        if (countryName === 'Republic of Korea') countryName = 'Korea, South';
        if (countryName === 'Ivory Coast') countryName = 'Cote d\'Ivoire';
        if (countryName === 'Myanmar') countryName = 'Burma';
        if (countryName === 'Swaziland') countryName = 'Eswatini';
        
        countries.push(countryName);
        values.push(item.total_value);
        countCounts.push(item.count);
        hoverText.push(
            `<b>${item.country}</b><br>` +
            `Funding: $${(item.total_value/1000000).toFixed(1)}M CAD<br>` +
            `Grants: ${item.count.toLocaleString()}`
        );
    });
    
    const data = [{
        type: 'choropleth',
        locationmode: 'country names',
        locations: countries,
        z: values,
        hovertemplate: hoverText.map(text => text + '<extra></extra>'),
        colorscale: [
            [0, '#f7f7f7'],      // Very light gray for no/minimal funding
            [0.1, '#fee5d9'],    // Light orange
            [0.3, '#fcbba1'],    // Medium light orange
            [0.5, '#fc9272'],    // Medium orange
            [0.7, '#fb6a4a'],    // Medium dark orange
            [1, '#de2d26']       // Dark red for highest funding
        ],
        colorbar: {
            title: {
                text: 'Funding Amount<br>(CAD)',
                font: { size: 12 }
            },
            tickmode: 'array',
            tickvals: [0, 10000000, 50000000, 100000000, 500000000, 1000000000],
            ticktext: ['$0', '$10M', '$50M', '$100M', '$500M', '$1B+'],
            x: 1.02,
            len: 0.8
        },
        marker: {
            line: {
                color: 'rgb(180,180,180)',
                width: 0.5
            }
        }
    }];
    
    const layout = {
        title: {
            text: 'Canadian International Development Funding by Country',
            font: { size: 16 },
            x: 0.5,
            xanchor: 'center'
        },
        geo: {
            showframe: false,
            showcoastlines: true,
            coastlinecolor: 'rgb(180,180,180)',
            showland: true,
            landcolor: 'rgb(243, 243, 243)',
            showocean: true,
            oceancolor: 'rgb(230, 245, 255)',
            projection: {
                type: 'natural earth'
            }
        },
        font: {
            family: 'Arial, sans-serif',
            size: 12
        },
        margin: { t: 60, r: 20, b: 20, l: 20 },
        height: 600
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: 'canada-gac-world-funding-map',
            height: 600,
            width: 1200,
            scale: 2
        }
    };
    
    Plotly.newPlot('worldMap', data, layout, config)
        .then(() => {
            console.log('‚úÖ Plotly world choropleth map loaded successfully!');
        })
        .catch(error => {
            console.error('‚ùå Error loading Plotly world map:', error);
            document.getElementById('worldMap').innerHTML = 
                '<div class="alert alert-danger text-center m-4">' +
                '<i class="fas fa-exclamation-triangle"></i> ' +
                'Unable to load world map visualization. Please refresh the page or contact support.' +
                '</div>';
        });
    }
});
</script>
{% endblock %}
